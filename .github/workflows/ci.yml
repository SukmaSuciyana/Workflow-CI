name: ML Model CI/CD Pipeline

on:
  push:
    paths:
      - 'MLProject/modelling.py'
      - 'MLProject/**'
    branches:
      - main
  pull_request:
    paths:
      - 'MLProject/modelling.py'
      - 'MLProject/**'
    branches:
      - main
  workflow_dispatch:

env:
  MLFLOW_TRACKING_URI: file:./mlruns
  DOCKER_IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/mlflow-model
  PYTHON_VERSION: '3.9'

jobs:
  train-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/conda.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install mlflow scikit-learn pandas numpy joblib
        
    - name: Verify data files
      run: |
        echo "Checking for data files in root directory..."
        ls -la
        echo ""
        echo "Checking preprocessed_data_auto directory..."
        ls -la preprocessed_data_auto/ || echo "Data directory not found in root"
        echo ""
        echo "Checking MLProject directory..."
        ls -la MLProject/
        
    - name: Train ML Model
      run: |
        cd MLProject
        python modelling.py
        
    - name: List MLflow artifacts
      run: |
        echo "MLflow runs directory:"
        ls -la MLProject/mlruns/
        find MLProject/mlruns -type f -name "MLmodel" -o -name "*.pkl"
        
    - name: Upload model artifacts to GitHub
      uses: actions/upload-artifact@v4
      with:
        name: ml-model-artifacts
        path: |
          MLProject/mlruns/**/*
        retention-days: 30
        
    - name: Verify MLflow Run
      run: |
        cd MLProject
        echo "Verifying MLflow run directory structure..."
        
        # Check if mlruns directory exists
        if [ ! -d "mlruns" ]; then
          echo "ERROR: mlruns directory not found!"
          exit 1
        fi
        
        # Find the latest meta.yaml file
        LATEST_META=$(find mlruns -type f -name "meta.yaml" -not -path "*/.*" 2>/dev/null | xargs ls -t 2>/dev/null | head -1)
        
        if [ -z "$LATEST_META" ]; then
          echo "ERROR: No MLflow run found! meta.yaml file is missing."
          echo "This suggests that modelling.py did not complete successfully or MLflow logging failed."
          exit 1
        fi
        
        echo "âœ“ MLflow run verified: $LATEST_META"
        
        # Extract and validate paths
        EXPERIMENT_ID=$(echo "$LATEST_META" | cut -d'/' -f2)
        RUN_ID=$(echo "$LATEST_META" | cut -d'/' -f3)
        
        echo "Experiment ID: $EXPERIMENT_ID"
        echo "Run ID: $RUN_ID"
        
        # Verify model artifact exists
        MODEL_ARTIFACT_PATH="mlruns/$EXPERIMENT_ID/$RUN_ID/artifacts/model"
        if [ ! -d "$MODEL_ARTIFACT_PATH" ]; then
          echo "ERROR: Model artifact directory not found at $MODEL_ARTIFACT_PATH"
          echo "Available artifacts:"
          ls -la "mlruns/$EXPERIMENT_ID/$RUN_ID/artifacts/" || echo "Artifacts directory is empty or missing"
          exit 1
        fi
        
        # Verify MLmodel file
        if [ ! -f "$MODEL_ARTIFACT_PATH/MLmodel" ]; then
          echo "ERROR: MLmodel descriptor file not found!"
          echo "This file is required for MLflow model serving."
          echo "Contents of model artifact directory:"
          ls -la "$MODEL_ARTIFACT_PATH"
          exit 1
        fi
        
        echo "âœ“ Model artifact verified at: $MODEL_ARTIFACT_PATH"
        echo "âœ“ MLmodel descriptor found"
        echo ""
        echo "MLflow run is ready for Docker image building!"
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
        
    - name: Build and Push Docker Image with MLflow
      run: |
        cd MLProject
        
        # Robust method to find the latest MLflow run
        echo "Searching for the latest MLflow run..."
        
        # Find all meta.yaml files, sort by modification time (newest first)
        LATEST_META_FILE=$(find mlruns -type f -name "meta.yaml" -not -path "*/.*" 2>/dev/null | xargs ls -t 2>/dev/null | head -1)
        
        if [ -z "$LATEST_META_FILE" ]; then
          echo "ERROR: No meta.yaml found in mlruns directory!"
          echo "Directory structure:"
          ls -la mlruns/ || echo "mlruns directory not found"
          exit 1
        fi
        
        echo "Latest meta.yaml found at: $LATEST_META_FILE"
        
        # Extract EXPERIMENT_ID and RUN_ID from the path
        # Path format: mlruns/<EXPERIMENT_ID>/<RUN_ID>/meta.yaml
        EXPERIMENT_ID=$(echo "$LATEST_META_FILE" | cut -d'/' -f2)
        RUN_ID=$(echo "$LATEST_META_FILE" | cut -d'/' -f3)
        
        echo "Extracted EXPERIMENT_ID: $EXPERIMENT_ID"
        echo "Extracted RUN_ID: $RUN_ID"
        
        # Validate that we have valid IDs
        if [ -z "$EXPERIMENT_ID" ] || [ -z "$RUN_ID" ]; then
          echo "ERROR: Failed to extract EXPERIMENT_ID or RUN_ID"
          exit 1
        fi
        
        # Verify the model artifact exists
        MODEL_PATH="mlruns/$EXPERIMENT_ID/$RUN_ID/artifacts/model"
        if [ ! -d "$MODEL_PATH" ]; then
          echo "ERROR: Model artifact not found at $MODEL_PATH"
          echo "Listing artifacts directory:"
          ls -la "mlruns/$EXPERIMENT_ID/$RUN_ID/artifacts/" || echo "Artifacts directory not found"
          exit 1
        fi
        
        echo "Model artifact verified at: $MODEL_PATH"
        
        # Verify MLmodel file exists (required by mlflow models build-docker)
        if [ ! -f "$MODEL_PATH/MLmodel" ]; then
          echo "ERROR: MLmodel file not found at $MODEL_PATH/MLmodel"
          echo "This indicates the model was not logged correctly by MLflow"
          exit 1
        fi
        
        echo "MLmodel file verified"
        echo ""
        echo "=========================================="
        echo "Building Docker image using MLflow"
        echo "=========================================="
        echo "Experiment ID: $EXPERIMENT_ID"
        echo "Run ID: $RUN_ID"
        echo "Model Path: $MODEL_PATH"
        echo "=========================================="
        echo ""
        
        # Generate Dockerfile using MLflow (without building)
        echo "Generating Dockerfile from MLflow model..."
        mlflow models generate-dockerfile \
          -m "$MODEL_PATH" \
          -d .
        
        if [ $? -ne 0 ]; then
          echo "ERROR: Failed to generate Dockerfile"
          exit 1
        fi
        
        echo "âœ“ Dockerfile generated successfully"
        echo ""
        
        # Fix common issues in generated Dockerfile
        echo "Patching Dockerfile for compatibility..."
        
        # Replace openjdk-8-jdk with openjdk-11-jdk (openjdk-8 no longer available)
        sed -i 's/openjdk-8-jdk/openjdk-11-jdk/g' Dockerfile
        
        # Fix JAVA_HOME path (8 -> 11)
        if grep -q "JAVA_HOME.*java-8-openjdk" Dockerfile; then
          echo "Fixing JAVA_HOME path for OpenJDK 11"
          sed -i 's|/usr/lib/jvm/java-8-openjdk-amd64|/usr/lib/jvm/java-11-openjdk-amd64|g' Dockerfile
          sed -i 's|java-8-openjdk|java-11-openjdk|g' Dockerfile
        fi
        
        # Fix Python 3.8 get-pip.py issue
        if grep -q "python3.8" Dockerfile && grep -q "get-pip.py" Dockerfile; then
          echo "Detected Python 3.8 with get-pip.py - fixing pip installation URL"
          sed -i 's|https://bootstrap.pypa.io/get-pip.py|https://bootstrap.pypa.io/pip/3.8/get-pip.py|g' Dockerfile
        fi
        
        # Smart removal of build tools
        sed -i 's/build-essential//' Dockerfile
        sed -i 's/cmake//' Dockerfile
        
        # Check if git is actually used before removing
        if ! grep -q "git clone\|git ls-remote" Dockerfile; then
          echo "âœ“ Removing git-core (not used)"
          sed -i 's/git-core//' Dockerfile
        fi
        
        # Check if maven is actually used before removing
        if ! grep -q "mvn " Dockerfile; then
          echo "âœ“ Removing maven (not used)"
          sed -i 's/maven//' Dockerfile
        fi
        
        # Clean up multiple spaces
        sed -i 's/  */ /g' Dockerfile
        
        # Fix Gunicorn configuration for proper binding
        if grep -q "gunicorn" Dockerfile; then
          echo "âœ“ Configuring Gunicorn for proper binding"
          
          if ! grep -q "GUNICORN_CMD_ARGS" Dockerfile; then
            sed -i '/^ENTRYPOINT\|^CMD/i ENV GUNICORN_CMD_ARGS="--bind=0.0.0.0:5000 --timeout=60 --workers=1"' Dockerfile
          fi
          
          if ! grep -q "CUDA_VISIBLE_DEVICES" Dockerfile; then
            sed -i '/^ENTRYPOINT\|^CMD/i ENV CUDA_VISIBLE_DEVICES=""' Dockerfile
            sed -i '/^ENTRYPOINT\|^CMD/i ENV TF_CPP_MIN_LOG_LEVEL="2"' Dockerfile
          fi
        fi
        
        echo "âœ“ Dockerfile patched successfully"
        echo ""
        echo "Patched Dockerfile content:"
        echo "=============================="
        cat Dockerfile
        echo "=============================="
        echo ""
        
        # Build Docker image using Docker CLI
        echo "Building Docker image with Docker CLI..."
        docker build -t ${{ env.DOCKER_IMAGE_NAME }}:latest .
        
        if [ $? -ne 0 ]; then
          echo "ERROR: Docker build failed"
          exit 1
        fi
        
        echo "âœ“ Docker image built successfully"
        
        cd ..
        
        # Tag the image with commit SHA
        echo "Tagging image with commit SHA..."
        docker tag ${{ env.DOCKER_IMAGE_NAME }}:latest ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
        
        # Push images to Docker Hub
        echo ""
        echo "Pushing images to Docker Hub..."
        docker push ${{ env.DOCKER_IMAGE_NAME }}:latest
        docker push ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
        
        echo ""
        echo "âœ“ Docker images pushed successfully!"
        
    - name: Generate Docker Image Report
      run: |
        cat > docker-image-report.txt <<EOF
        Docker Image Build Report
        ========================
        
        Repository: ${{ env.DOCKER_IMAGE_NAME }}
        Tags:
          - latest
          - ${{ github.sha }}
        
        Docker Hub URL: https://hub.docker.com/r/${{ secrets.DOCKERHUB_USERNAME }}/mlflow-model
        
        Pull Command:
        docker pull ${{ env.DOCKER_IMAGE_NAME }}:latest
        
        Run Command:
        docker run -p 5000:5000 ${{ env.DOCKER_IMAGE_NAME }}:latest
        
        Built at: $(date -u)
        GitHub Actions Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        EOF
        
        cat docker-image-report.txt
        
    - name: Upload Docker Report
      uses: actions/upload-artifact@v4
      with:
        name: docker-build-report
        path: docker-image-report.txt
        
    - name: Summary
      run: |
        echo "## ðŸŽ‰ ML Model CI/CD Pipeline Completed! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Model artifacts uploaded to GitHub Actions" >> $GITHUB_STEP_SUMMARY
        echo "- Docker image pushed to Docker Hub" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ³ Docker Image" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "docker pull ${{ env.DOCKER_IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
        echo "docker run -p 5000:5000 ${{ env.DOCKER_IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
        echo "- [Docker Hub Image](https://hub.docker.com/r/${{ secrets.DOCKERHUB_USERNAME }}/mlflow-model)" >> $GITHUB_STEP_SUMMARY
        echo "- [GitHub Actions Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
